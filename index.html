<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            font-size: 28px;
        }
        
        .user-selector {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .user-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .user-btn:hover {
            border-color: #3498db;
        }
        
        .connection-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        .task-list, .notification-list, .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .task-item, .notification-item, .activity-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .task-item:hover {
            background: #e9ecef;
        }
        
        .task-item.done {
            border-left-color: #27ae60;
            opacity: 0.7;
        }
        
        .task-item.in_progress {
            border-left-color: #f39c12;
        }
        
        .task-item.todo {
            border-left-color: #3498db;
        }
        
        .notification-item.unread {
            background: #e3f2fd;
            font-weight: 500;
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .task-meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.todo {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-badge.in_progress {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .status-badge.done {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .analytics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        
        .timestamp {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 5px;
        }
        
        .badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .modal-header h2 {
            margin: 0;
            border: none;
            padding: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #2c3e50;
        }
        
        .task-details {
            margin-bottom: 20px;
        }
        
        .task-description {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .comments-section {
            margin-top: 30px;
        }
        
        .comment-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }
        
        .comment-author {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .comment-content {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .comment-form {
            margin-top: 15px;
        }
        
        .mention-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Task Management System</h1>
            <div class="user-selector">
                <span>Current User:</span>
                <button class="user-btn active" onclick="switchUser(1)">Han (ID: 1)</button>
                <button class="user-btn" onclick="switchUser(2)">Chewy (ID: 2)</button>
                <button class="user-btn" onclick="switchUser(3)">Luke (ID: 3)</button>
                <span class="connection-status disconnected" id="ws-status">WebSocket: Disconnected</span>
            </div>
        </header>

        <!-- Analytics Dashboard -->
        <div class="analytics">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-completed">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-progress">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-notifs">0</div>
                <div class="stat-label">Notifications</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Create Task -->
            <div class="card">
                <h2>Create Task</h2>
                <form id="task-form" onsubmit="createTask(event)">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="task-title" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="task-description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Project</label>
                        <select id="task-project" required>
                            <option value="">Select project...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Assign To</label>
                        <select id="task-assignee">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                    <button type="submit">Create Task</button>
                </form>
            </div>

            <!-- Notifications -->
            <div class="card">
                <h2>
                    Notifications
                    <span class="badge" id="notif-badge">0</span>
                    <button class="btn-small btn-secondary" onclick="markAllRead()">Mark All Read</button>
                </h2>
                <div class="notification-list" id="notifications">
                    <div class="empty-state">No notifications</div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="card">
                <h2>Activity Feed</h2>
                <div class="activity-list" id="activity">
                    <div class="empty-state">No activity yet</div>
                </div>
            </div>
        </div>

        <!-- Tasks Grid -->
        <div class="grid">
            <div class="card">
                <h2>To Do</h2>
                <div class="task-list" id="tasks-todo">
                    <div class="empty-state">No tasks</div>
                </div>
            </div>

            <div class="card">
                <h2>In Progress</h2>
                <div class="task-list" id="tasks-progress">
                    <div class="empty-state">No tasks</div>
                </div>
            </div>

            <div class="card">
                <h2>Done</h2>
                <div class="task-list" id="tasks-done">
                    <div class="empty-state">No tasks</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-task-title">Task Details</h2>
                <button class="close-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            
            <div class="task-details">
                <div class="form-group">
                    <label>Description</label>
                    <div class="task-description" id="modal-task-description">No description</div>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <div id="modal-task-status"></div>
                </div>
                
                <div class="form-group">
                    <label>Assigned To</label>
                    <div id="modal-task-assignee">Unassigned</div>
                </div>
                
                <div class="form-group">
                    <button class="btn-small" id="modal-status-btn" onclick="updateTaskStatusFromModal()">Update Status</button>
                </div>
            </div>
            
            <div class="comments-section">
                <h2>Comments</h2>
                <div id="modal-comments">
                    <div class="empty-state">No comments yet</div>
                </div>
                
                <form class="comment-form" onsubmit="addComment(event)">
                    <div class="form-group">
                        <label>Add Comment</label>
                        <textarea id="comment-content" placeholder="Type your comment here... Use @username to mention someone" rows="3"></textarea>
                        <div class="mention-hint">Tip: Use @Han, @Chewy, or @Luke to mention team members</div>
                    </div>
                    <button type="submit">Add Comment</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let currentUserId = 1;
        let currentTaskId = null;
        let ws = null;
        let usersMap = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            loadUsers();
            loadTasks();
            loadNotifications();
            loadActivity();
            loadAnalytics();
            connectWebSocket();
            
            // Refresh every 5 seconds
            setInterval(() => {
                loadTasks();
                loadNotifications();
                loadActivity();
                loadAnalytics();
                if (currentTaskId) {
                    loadTaskDetails(currentTaskId);
                }
            }, 5000);
        });

        // WebSocket
        function connectWebSocket() {
            ws = new WebSocket(`ws://127.0.0.1:8000/ws/${currentUserId}`);
            
            ws.onopen = () => {
                document.getElementById('ws-status').textContent = 'WebSocket: Connected';
                document.getElementById('ws-status').className = 'connection-status connected';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);
                
                if (data.type === 'notification' || data.type === 'connection') {
                    loadNotifications();
                    loadActivity();
                    loadTasks();
                    loadAnalytics();
                    if (currentTaskId) {
                        loadTaskDetails(currentTaskId);
                    }
                }
            };
            
            ws.onerror = () => {
                document.getElementById('ws-status').textContent = 'WebSocket: Error';
                document.getElementById('ws-status').className = 'connection-status disconnected';
            };
            
            ws.onclose = () => {
                document.getElementById('ws-status').textContent = 'WebSocket: Disconnected';
                document.getElementById('ws-status').className = 'connection-status disconnected';
            };
            
            // Keep alive
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send('ping');
                }
            }, 30000);
        }

        // Switch User
        function switchUser(userId) {
            currentUserId = userId;
            document.querySelectorAll('.user-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (ws) ws.close();
            connectWebSocket();
            
            loadTasks();
            loadNotifications();
            loadActivity();
            loadAnalytics();
        }

        // Load Projects
        async function loadProjects() {
            const response = await fetch(`${API_BASE}/projects/`);
            const projects = await response.json();
            const select = document.getElementById('task-project');
            select.innerHTML = '<option value="">Select project...</option>';
            projects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
        }

        // Load Users
        async function loadUsers() {
            const response = await fetch(`${API_BASE}/users/`);
            const users = await response.json();
            const select = document.getElementById('task-assignee');
            select.innerHTML = '<option value="">Unassigned</option>';
            users.forEach(u => {
                usersMap[u.id] = u;
                select.innerHTML += `<option value="${u.id}">${u.full_name} (@${u.username})</option>`;
            });
        }

        // Load Tasks
        async function loadTasks() {
            const response = await fetch(`${API_BASE}/tasks/`);
            const tasks = await response.json();
            
            const todoDiv = document.getElementById('tasks-todo');
            const progressDiv = document.getElementById('tasks-progress');
            const doneDiv = document.getElementById('tasks-done');
            
            todoDiv.innerHTML = '';
            progressDiv.innerHTML = '';
            doneDiv.innerHTML = '';
            
            const todoTasks = tasks.filter(t => t.status === 'todo');
            const progressTasks = tasks.filter(t => t.status === 'in_progress');
            const doneTasks = tasks.filter(t => t.status === 'done');
            
            if (todoTasks.length === 0) todoDiv.innerHTML = '<div class="empty-state">No tasks</div>';
            if (progressTasks.length === 0) progressDiv.innerHTML = '<div class="empty-state">No tasks</div>';
            if (doneTasks.length === 0) doneDiv.innerHTML = '<div class="empty-state">No tasks</div>';
            
            todoTasks.forEach(task => todoDiv.innerHTML += renderTask(task));
            progressTasks.forEach(task => progressDiv.innerHTML += renderTask(task));
            doneTasks.forEach(task => doneDiv.innerHTML += renderTask(task));
        }

        // Render Task
        function renderTask(task) {
            const assigneeName = task.assignee_id && usersMap[task.assignee_id] 
                ? usersMap[task.assignee_id].full_name 
                : 'Unassigned';
            
            return `
                <div class="task-item ${task.status}" onclick="openTaskModal(${task.id})">
                    <div class="task-title">${task.title}</div>
                    <div class="task-meta">
                        <span class="status-badge ${task.status}">${task.status.replace('_', ' ')}</span>
                        ${assigneeName}
                    </div>
                </div>
            `;
        }

        // Open Task Modal
        async function openTaskModal(taskId) {
            currentTaskId = taskId;
            await loadTaskDetails(taskId);
            document.getElementById('task-modal').classList.add('active');
        }

        // Close Task Modal
        function closeTaskModal() {
            currentTaskId = null;
            document.getElementById('task-modal').classList.remove('active');
        }

        // Load Task Details
        async function loadTaskDetails(taskId) {
            const response = await fetch(`${API_BASE}/tasks/${taskId}`);
            const task = await response.json();
            
            document.getElementById('modal-task-title').textContent = task.title;
            document.getElementById('modal-task-description').textContent = task.description || 'No description';
            document.getElementById('modal-task-status').innerHTML = `<span class="status-badge ${task.status}">${task.status.replace('_', ' ')}</span>`;
            
            const assigneeName = task.assignee_id && usersMap[task.assignee_id] 
                ? usersMap[task.assignee_id].full_name 
                : 'Unassigned';
            document.getElementById('modal-task-assignee').textContent = assigneeName;
            
            // Update status button
            const statusBtn = document.getElementById('modal-status-btn');
            if (task.status === 'todo') {
                statusBtn.textContent = 'Start Task';
                statusBtn.style.display = 'inline-block';
            } else if (task.status === 'in_progress') {
                statusBtn.textContent = 'Complete Task';
                statusBtn.style.display = 'inline-block';
            } else {
                statusBtn.style.display = 'none';
            }
            
            // Load comments
            await loadComments(taskId);
        }

        // Load Comments
        async function loadComments(taskId) {
            const response = await fetch(`${API_BASE}/tasks/${taskId}/comments`);
            const comments = await response.json();
            
            const commentsDiv = document.getElementById('modal-comments');
            
            if (comments.length === 0) {
                commentsDiv.innerHTML = '<div class="empty-state">No comments yet</div>';
                return;
            }
            
            commentsDiv.innerHTML = comments.map(c => {
                const author = usersMap[c.author_id];
                const authorName = author ? author.full_name : `User ${c.author_id}`;
                return `
                    <div class="comment-item">
                        <div class="comment-author">${authorName}</div>
                        <div class="comment-content">${c.content}</div>
                        <div class="timestamp">${new Date(c.created_at).toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }

        // Add Comment
        async function addComment(event) {
            event.preventDefault();
            
            if (!currentTaskId) return;
            
            const content = document.getElementById('comment-content').value;
            
            await fetch(`${API_BASE}/comments/?user_id=${currentUserId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content: content,
                    task_id: currentTaskId
                })
            });
            
            document.getElementById('comment-content').value = '';
            await loadComments(currentTaskId);
            loadActivity();
            loadNotifications();
        }

        // Update Task Status from Modal
        async function updateTaskStatusFromModal() {
            if (!currentTaskId) return;
            
            const response = await fetch(`${API_BASE}/tasks/${currentTaskId}`);
            const task = await response.json();
            
            const newStatus = task.status === 'todo' ? 'in_progress' : 'done';
            
            await fetch(`${API_BASE}/tasks/${currentTaskId}?user_id=${currentUserId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: newStatus})
            });
            
            await loadTaskDetails(currentTaskId);
            loadTasks();
            loadAnalytics();
        }

        // Create Task
        async function createTask(event) {
            event.preventDefault();
            
            const data = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                project_id: parseInt(document.getElementById('task-project').value),
                assignee_id: document.getElementById('task-assignee').value ? parseInt(document.getElementById('task-assignee').value) : null,
                priority: 1
            };
            
            await fetch(`${API_BASE}/tasks/?user_id=${currentUserId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            document.getElementById('task-form').reset();
            loadTasks();
            loadAnalytics();
        }

        // Load Notifications
        async function loadNotifications() {
            const response = await fetch(`${API_BASE}/notifications?user_id=${currentUserId}`);
            const data = await response.json();
            
            const div = document.getElementById('notifications');
            const badge = document.getElementById('notif-badge');
            
            badge.textContent = data.unread_count;
            badge.style.display = data.unread_count > 0 ? 'inline-block' : 'none';
            document.getElementById('stat-notifs').textContent = data.unread_count;
            
            if (data.notifications.length === 0) {
                div.innerHTML = '<div class="empty-state">No notifications</div>';
                return;
            }
            
            div.innerHTML = data.notifications.map(n => `
                <div class="notification-item ${!n.read ? 'unread' : ''}">
                    <div>${n.message}</div>
                    <div class="timestamp">${new Date(n.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }

        // Load Activity
        async function loadActivity() {
            const response = await fetch(`${API_BASE}/activity-feed?user_id=${currentUserId}&limit=10`);
            const activities = await response.json();
            
            const div = document.getElementById('activity');
            
            if (activities.length === 0) {
                div.innerHTML = '<div class="empty-state">No activity yet</div>';
                return;
            }
            
            div.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <strong>${a.event_type.replace(/_/g, ' ')}</strong>
                    <div class="timestamp">${new Date(a.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }

        // Load Analytics
        async function loadAnalytics() {
            const response = await fetch(`${API_BASE}/analytics/completion-rate`);
            const data = await response.json();
            
            document.getElementById('stat-total').textContent = data.total_tasks;
            document.getElementById('stat-completed').textContent = data.completed_tasks;
            document.getElementById('stat-progress').textContent = data.in_progress;
        }

        // Mark All Read
        async function markAllRead() {
            await fetch(`${API_BASE}/notifications/mark-read?user_id=${currentUserId}`, {
                method: 'POST'
            });
            loadNotifications();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('task-modal');
            if (event.target === modal) {
                closeTaskModal();
            }
        }
    </script>
</body>
</html>